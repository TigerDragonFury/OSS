# OSS System - Connected Architecture Summary

## ğŸ”„ Proper Data Flow (After Running Migrations)

### Land Purchases
```
Buy Land
  â†“
Extract Equipment â†’ Store in Warehouse â†’ (Later) Sell â†’ Income Dashboard
  â†“
Sell Scrap Metal â†’ Income Dashboard (Auto-tracked)
```

### Vessel Operations
```
Vessel
  â†“
Create Overhaul (linked to vessel) â†’ Shows on vessel page
  â†“
Rent Out Vessel â†’ Rental Income â†’ Income Dashboard + Vessel page
```

### Income Tracking (Everything Connected)
```
All Revenue Sources:
- Scrap Metal Sales â†’ income_records (auto-created)
- Vessel Rentals â†’ income_records (auto-created)
- Equipment Sales from Warehouse â†’ income_records (auto-created)
- Dashboard shows TOTAL INCOME from all sources
```

---

## ğŸ“‹ Migration Steps (Run in Supabase SQL Editor)

**Go to:** https://app.supabase.com/project/bybdoxmcyrzpavnvddfa/sql

### **STEP 1: Core Schema** (REQUIRED - Fixes 406 errors)
Run these files in order:
1. `supabase-schema.sql` - Creates all tables
2. `fix-rls-policies.sql` - Disables security restrictions
3. `update-companies-types.sql` - Adds company categorization
4. `fix-scrap-sales-units.sql` - Changes kg â†’ tons + auto-sync

### **STEP 2: Architecture Fix** (NEW - Required for connections)
5. `fix-architecture-connections.sql` - **RUN THIS TO GET EVERYTHING CONNECTED**
   - Removes buyer fields from equipment
   - Adds warehouse_id to equipment
   - Creates income_records table (tracks ALL revenue)
   - Creates vessel_rentals table
   - Creates warehouse_sales table
   - Links overhauls to vessels
   - Auto-creates income when: scrap sold, vessel rented, equipment sold

---

## âœ… What Got Fixed

### 1. Equipment Flow (FIXED)
**Before:** âŒ Equipment had "buyer" fields â†’ treated as immediately sold
**After:** âœ… Equipment â†’ Warehouse â†’ (Later) Sale from warehouse = Income

**UI Changes:**
- Land equipment form now asks for "Warehouse Location" (not buyer)
- Status changed: "sold_as_is" â†’ "in_warehouse"
- Equipment stored first, sold later through warehouse

### 2. Income Tracking (NEW)
**Before:** âŒ No income tracking, sales not visible on dashboard
**After:** âœ… `income_records` table tracks:
- Scrap sales
- Vessel rentals  
- Equipment sales from warehouse
- All auto-synced to dashboard

**How it works:**
- Sell scrap â†’ trigger auto-creates income record
- Rent vessel â†’ trigger auto-creates income record
- Sell equipment from warehouse â†’ trigger auto-creates income record
- Dashboard queries income_records for total revenue

### 3. Vessel Connections (FIXED)
**Before:** âŒ Overhauls separate from vessels, no rentals
**After:** âœ… 
- Overhauls linked to specific vessels (vessel_id)
- Vessel page shows all overhauls for that vessel
- Rental tracking with income

### 4. Tonnage Sync (FIXED)
**Before:** âŒ Using kg for scrap sales, tons for land purchases â†’ no sync
**After:** âœ…
- Everything uses tons
- Remaining tonnage auto-updates when scrap sold
- Example: 300 tons bought, 300 tons sold = 0 remaining âœ“

---

## ğŸ¯ Next Features to Build (UI Pages Needed)

### 1. Vessel Rental Page (URGENT)
**Location:** `/dashboard/marine/rentals`
**Purpose:** Track vessel rentals and income
**Features:**
- Select vessel from dropdown
- Enter customer, date range, daily rate
- Shows total rental income
- Auto-creates income record when payment marked as paid
- Links to vessel page

### 2. Warehouse Sales Page (URGENT)
**Location:** `/dashboard/warehouses/[id]/sales`
**Purpose:** Sell equipment from warehouse
**Features:**
- List equipment in warehouse
- "Sell" button opens form
- Enter sale price, customer, payment method
- Auto-creates income record
- Removes from inventory or marks as "sold"

### 3. Income Dashboard Widget (PRIORITY)
**Location:** Update `/dashboard/page.tsx`
**Purpose:** Show total income from all sources
**Features:**
- Total Income card (from income_records)
- Breakdown: Scrap Sales, Vessel Rentals, Equipment Sales
- Recent income transactions list
- Charts/trends

### 4. Vessel Detail Page Update (PRIORITY)
**Location:** `/dashboard/marine/vessels/[id]`
**Add sections:**
- Overhauls linked to this vessel
- Rental history for this vessel
- Total income generated by this vessel
- Current status (available, rented, in overhaul)

### 5. Warehouse Inventory Page (NEEDED)
**Location:** `/dashboard/warehouses/[id]`
**Purpose:** Manage warehouse inventory
**Features:**
- List all equipment in warehouse
- Shows: name, condition, estimated value, source (which land)
- "Move to another warehouse" button
- "Sell" button (opens warehouse sale form)
- Status changes (available â†’ reserved â†’ sold)

---

## ğŸ”§ Database Schema (After Migrations)

### New Tables Created:
```sql
income_records         -- Tracks ALL revenue
  - income_type: scrap_sale, equipment_sale, vessel_rental, service, other
  - source_type: land, vessel, warehouse, other
  - source_id: Links back to land/vessel/warehouse
  - reference_id: Links to specific sale/rental record
  - amount, customer, description, payment_method

vessel_rentals         -- Vessel rental tracking
  - vessel_id (links to vessels)
  - customer, start_date, end_date, daily_rate
  - total_amount, payment_status, status

warehouse_sales        -- Equipment sales from warehouse
  - warehouse_id (links to warehouses)
  - land_equipment_id (links back to original equipment)
  - sale_price, customer, payment_method
  - Auto-creates income record

```

### Modified Tables:
```sql
land_equipment
  - Added: warehouse_id (required - links to warehouses)
  - Removed: dealer_company_id, buyer_name, sale_price, sale_date
  - Status changed: sold_as_is â†’ in_warehouse

vessel_overhaul_projects
  - Added: vessel_id (links overhaul to specific vessel)

land_scrap_sales
  - Changed: quantity_kg â†’ quantity_tons
  - Changed: price_per_kg â†’ price_per_ton
  - Auto-creates income record on insert
```

### Triggers Created (Auto-sync):
1. `auto_income_scrap_sale` - Creates income when scrap sold
2. `auto_income_vessel_rental` - Creates income when vessel rented & paid
3. `auto_income_warehouse_sale` - Creates income when equipment sold
4. `update_remaining_tonnage_on_sale` - Updates land tonnage when scrap sold

---

## ğŸ“Š Current System State

### âœ… Completed:
- Equipment â†’ Warehouse connection (form updated)
- Scrap sales use tons (matches land purchases)
- Income tracking architecture (database)
- Triggers for auto-income creation
- Companies categorization (contractors, vendors, scrap buyers)
- Sync utilities (Sync Expenses, Sync Tonnage)

### â³ Needs UI Pages:
- Vessel rentals page (create/manage rentals)
- Warehouse inventory page (view equipment in warehouse)
- Warehouse sales page (sell equipment from warehouse)
- Income dashboard widget (show total revenue)
- Update vessel detail page (show linked overhauls & rentals)

### ğŸ”´ Blocking Migration:
**You MUST run `fix-architecture-connections.sql` before:**
- Equipment form will break (looking for warehouse_id)
- Income won't track
- Overhauls won't link to vessels
- No rental tracking

---

## ğŸš€ Quick Start (After Migrations Run)

1. **Run ALL SQL files** in Supabase SQL Editor (see Migration Steps above)
2. **Restart PostgREST** (Settings â†’ API â†’ Restart PostgREST) to refresh schema
3. **Test the flow:**
   - Buy land â†’ Add equipment â†’ Select warehouse (form now has warehouse dropdown)
   - Sell scrap â†’ Check if income_records has new entry
   - Dashboard should show updated income (after refreshing)

4. **Ready to build:** Vessel Rentals page, Warehouse Sales page, Income Widget

---

## ğŸ’¡ Key Business Logic

### Equipment Lifecycle:
```
Land Purchase
  â†“
Extract Equipment (estimated_value set)
  â†“
Store in Warehouse (warehouse_id required, status = 'in_warehouse')
  â†“
(Time passes - equipment stored)
  â†“
Sell from Warehouse (warehouse_sales record created)
  â†“
Income Record Auto-Created (income_records)
  â†“
Shows on Dashboard
```

### Scrap Sales:
```
Land Purchase (estimated_tonnage = 300)
  â†“
Sell Scrap (quantity_tons = 150) â†’ Income auto-created
  â†“
Remaining tonnage auto-updates (150 left)
  â†“
Sell more (quantity_tons = 150) â†’ Income auto-created
  â†“
Remaining tonnage = 0
```

### Vessel Overhaul:
```
Vessel (id: abc-123)
  â†“
Create Overhaul (vessel_id = abc-123)
  â†“
Shows on Vessel Detail Page (linked via vessel_id)
  â†“
Track expenses per overhaul
  â†“
Expenses sync to vessel total_spent
```

### Vessel Rental:
```
Vessel (id: abc-123)
  â†“
Create Rental (vessel_id = abc-123, daily_rate = 5000, days = 10)
  â†“
Mark as Paid (payment_status = 'paid')
  â†“
Income Record Auto-Created (50,000 AED)
  â†“
Shows on Dashboard & Vessel Page
```

---

## ğŸ¨ UI/UX Improvements Needed

1. **Dashboard:**
   - Add "Total Income" card (from income_records)
   - Add "Recent Income" table
   - Add income chart (by type: scrap, rentals, equipment sales)

2. **Vessel Page:**
   - Add "Overhauls" tab (shows all overhauls for this vessel)
   - Add "Rentals" tab (shows rental history)
   - Add "Income Generated" card (sum of rentals)
   - Add "Status" badge (Available, Rented, In Overhaul)

3. **Warehouse Pages:**
   - Create warehouse landing page (list all warehouses)
   - Create warehouse detail page (show equipment in warehouse)
   - Add "Sell Equipment" button (opens warehouse sale form)
   - Show equipment source (which land it came from)

4. **Navigation:**
   - Add "Rentals" under Marine Services section
   - Add "Warehouse Management" section
   - Add "Income Tracking" under Finance section

---

## âœ… Testing Checklist

After running migrations:
- [ ] Create land purchase
- [ ] Add equipment â†’ Select warehouse (form works?)
- [ ] Sell scrap â†’ Check income_records table (auto-created?)
- [ ] Check remaining tonnage (auto-updated?)
- [ ] View dashboard (shows income?)
- [ ] Create overhaul â†’ Links to vessel?
- [ ] Create rental â†’ Auto-creates income?
- [ ] Sell equipment from warehouse â†’ Auto-creates income?

---

**All SQL files are ready in your project folder:**
- `C:\Users\Exceed\Desktop\oss-system\*.sql`

**Run them in Supabase SQL Editor to make everything work!**
